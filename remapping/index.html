<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Remapping - Yelmo-docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Remapping";
        var mkdocs_page_input_path = "remapping.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Yelmo-docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dependencies/">Dependencies</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../parameters/">Parameters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../yelmo-variables/">Variables</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../yelmo-io/">Input/output</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../example-programs/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../hpc-notes/">HPC notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-with-yelmox/">Running with YelmoX</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Yelmo-docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Remapping</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="remapping">Remapping</h1>
<p>Yelmo runs on a Cartesian (x/y) grid. Often input data comes in many formats, global lat/lon grids, projections and sets of points. It is important to have robust remapping tools.</p>
<p>Typically for a given domain, we define a Polar Stereographic projection to be able to convert lat/lon data points onto a Cartesian plane. For Antarctica, for example, the standard projection has the following parameters:</p>
<pre><code class="language-bash">int polar_stereographic ;
    polar_stereographic:grid_mapping_name = &quot;polar_stereographic&quot; ;
    polar_stereographic:straight_vertical_longitude_from_pole = 0. ;
    polar_stereographic:latitude_of_projection_origin = -71. ;
    polar_stereographic:angle_of_oblique_tangent = 19. ;
    polar_stereographic:scale_factor_at_projection_origin = 1. ;
    polar_stereographic:false_easting = 0. ;
    polar_stereographic:false_northing = 0. ;
</code></pre>
<h2 id="naming-files">Naming files</h2>
<p>For grids used by Yelmo, we generally use an abbreviation for the domain name followed by the resolution. So for Antarctica, we could have the grids <code>ANT-32KM</code> or <code>ANT-16KM</code> for a 32km or 16km grid, respectively. Data that have been projected onto these grids are saved with the grid name as a prefix followed by a general name that specifies the type of data, e.g., <code>CLIM</code> or <code>TOPO</code>, finally followed by more descriptive information about the specific dataset <code>IPSL-14Ma</code> or <code>IPSL-PD-CTRL</code>. For example, the latest topopgraphy dataset we use is called the RTopo2.0.1 dataset, so this is processed into a file called <code>ANT-32KM_TOPO-RTOPO-2.0.1.nc</code>.</p>
<h2 id="fields-yelmo-needs">Fields Yelmo needs</h2>
<p>To drive Yelmo with boundary conditions derived from a climate model, it needs the following fields to be defined on the Polar Stereographic grid:</p>
<ul>
<li>Climatological mean near-surface air temperature [monthly]</li>
<li>Climatological mean precipitation [monthly]</li>
<li>Surface elevation</li>
<li>Sea level</li>
<li>
<p>Ice thickness</p>
</li>
<li>
<p>Climatological mean 3D ocean temperature [annual]</p>
</li>
<li>Climatological mean 3D ocean salinity [annual]</li>
<li>Oceanic bathymetry</li>
</ul>
<p>Likely these would be processed into two or more separate files, e.g., one for climate <code>CLIM</code> variables and another for ocean <code>OCN</code> variables.</p>
<h2 id="preprocessing-data-using-cdo">Preprocessing data using <code>cdo</code></h2>
<p>As a first step, the Climate Data Operators <code>cdo</code> package is great for most preprocessing steps. It can handle averaging data over time and space, merging data files, extracting individual variables etc. See the extensive documentation and examples online.</p>
<p>For example, it is possible to use the command <code>cdo selvar</code> to extract specific variables from a file:</p>
<pre><code class="language-bash">cdo selvar,t2m,precip diane_C14Ma_1_5PAL_SE_4750_4849_1M_histmth.nc ipsl_tmp1.nc
</code></pre>
<p>If you have several variables in individual files, you can then conveniently merge them into one file usine <code>merge</code> (it's better if they have the same shape):</p>
<pre><code class="language-bash"># Extract t2m to a temporary file
cdo selvar,t2m diane_C14Ma_1_5PAL_SE_4750_4849_1M_histmth.nc ipsl_tmp1.nc

# Extract precip to a temporary file
cdo selvar,precip diane_C14Ma_1_5PAL_SE_4750_4849_1M_histmth.nc ipsl_tmp2.nc

# Merge the two individual variable files into one convenient file
cdo merge ipsl_tmp1.nc ipsl_tmp2.nc ipsl_tmp3.nc
</code></pre>
<p>There are many other useful commands, particularly for getting monthly means <code>cdo monmean ...</code> and other statistics.</p>
<p>Resources:</p>
<p>CDO Documentation page:
<a href="https://code.mpimet.mpg.de/projects/cdo/wiki/Cdo#Documentation">https://code.mpimet.mpg.de/projects/cdo/wiki/Cdo#Documentation</a></p>
<p>CDO User guide:
<a href="https://code.mpimet.mpg.de/projects/cdo/embedded/cdo.pdf">https://code.mpimet.mpg.de/projects/cdo/embedded/cdo.pdf</a></p>
<p>CDO Reference card:
<a href="https://code.mpimet.mpg.de/projects/cdo/embedded/cdo_refcard.pdf">https://code.mpimet.mpg.de/projects/cdo/embedded/cdo_refcard.pdf</a></p>
<h2 id="using-cdo-for-remapping">Using <code>cdo</code> for remapping</h2>
<p>To remap a data file from lat/lon coordinates to our projection, <code>cdo</code> needs a grid description file that describes the target Polar Stereographic projection grid. For example, for a 32km resolution domain, we would use the following file named <code>grid_ANT-32KM.txt</code>:</p>
<pre><code class="language-bash">gridtype = projection
gridsize =      36481
xsize    =        191
ysize    =        191
xname    = xc
xunits   = km
yname    = yc
yunits   = km
xfirst   =    -3040.000000
xinc     =       32.000000
yfirst   =    -3040.000000
yinc     =       32.000000
grid_mapping = crs
grid_mapping_name = polar_stereographic
straight_vertical_longitude_from_pole =        0.000
latitude_of_projection_origin =      -90.000
standard_parallel =      -71.000
false_easting =        0.000
false_northing =        0.000
semi_major_axis =        6378137.000
inverse_flattening =         298.25722356
</code></pre>
<p>With this file defined, it's easy to perform projections using the <code>cdo remap*</code> commands. To perform a bicubic interpolation, call:</p>
<pre><code class="language-bash">cdo remapbic,grid_ANT-32KM.txt diane_C14Ma_1_5PAL_SE_4750_4849_1M_histmth.nc ANT-32KM_test-bic.nc
</code></pre>
<p>Here, <code>remapbic</code> specifies bicubic interpolation and <code>grid_ANT-32KM.txt</code> defines the target grid as above. Then the source dataset is specified and the desired output file <code>ANT-32KM_test.nc</code>.</p>
<p>To perform conservative interpolation, replace <code>remapbic</code> with <code>remapcon</code>:</p>
<pre><code class="language-bash">cdo remapcon,grid_ANT-32KM.txt diane_C14Ma_1_5PAL_SE_4750_4849_1M_histmth.nc ANT-32KM_test-con.nc
</code></pre>
<p>Conservative interpolation is generally preferred, especially when going from a high resolution to a lower resolution, as it avoids unwanted interpolation artifacts and conserves the quantity being remapped. However, from low resolution to high resolution, conservative interpolation can result in more "blocky" fields with abrupt changes in values. Thus, in this case, bicubic interpolation, or conservative interpolation with additional Gaussian smoothing is better. The latter is not supported by <code>cdo</code>, but can be acheived with other tools.</p>
<p>One option for processing may be a conservative remapping, following by a smoothing step:</p>
<pre><code class="language-bash">cdo remapcon,grid_ANT-32KM.txt diane_C14Ma_1_5PAL_SE_4750_4849_1M_histmth.nc ANT-32KM_test-con.nc
cdo smooth,radius=128km ANT-32KM_test-con.nc ANT-32KM_test-con-smooth.nc

</code></pre>
<p>The smoothing radius should be chosen such that it is the smallest value possible that removes blocky artifacts from the field.</p>
<h2 id="summary">Summary</h2>
<p>It can be tedious to process data from a climate model into the right format to drive Yelmo. Tools like <code>cdo</code> help to reduce this burden. Other tools like NetCDF Operator <code>NCO</code> and today numerous Python-based libraries and tools can also be used.</p>
<p>It is best to define a script or program with all the processing steps clearly defined. That way, when new data becomes available from the same model, it is easy to process it systematically (and reproducibly) in the same way without any trouble.</p>
<h2 id="remapping-restart-file">Remapping restart file</h2>
<p>Sometimes we may want to restart a simulation at a new resolution - i.e., perform a spinup simulation at relatively low resolution and then continue the simulation at higher resolution.</p>
<ol>
<li>Use <code>cdo</code> to remap the restart file based on the grid definition files.</li>
</ol>
<pre><code class="language-bash"># Define env variables as shortcuts to locations of grid files
grid_src=/Users/robinson/models/EURICE/gridding/maps/grid_GRL-32KM.txt
grid_tgt=/Users/robinson/models/EURICE/gridding/maps/grid_GRL-16KM.txt

# Call remapping
cdo remapcon,${grid_tgt} -setgrid,${grid_src} yelmo_restart.nc yelmo_restart_16km.nc
</code></pre>
<p>Let's do a test. First, run a short 32km Greenland simulation and generate a restart file:</p>
<pre><code class="language-bash">./runme -r -e initmip -n par/yelmo_initmip.nml -o output/restarts/sim0-32km -p ctrl.time_end=100 ctrl.time_equil=0 ctrl.clim_nm=&quot;clim_pd_grl&quot; yelmo.domain=&quot;Greenland&quot; yelmo.grid_name=&quot;GRL-32KM&quot;
</code></pre>
<p>That simulation should have produced a nice restart file. Let's test a normal 32km simulation that continues from this restart file.</p>
<pre><code class="language-bash">./runme -r -e initmip -n par/yelmo_initmip.nml -o output/restarts/sim1-32km -p ctrl.time_end=100 ctrl.time_equil=0 ctrl.clim_nm=&quot;clim_pd_grl&quot; yelmo.domain=&quot;Greenland&quot; yelmo.grid_name=&quot;GRL-32KM&quot; yelmo.restart=&quot;../sim0-32km/yelmo_restart.nc&quot;
</code></pre>
<p>Ok, now generate scrip map file to interpolate from 32km down to 16km.</p>
<pre><code class="language-bash">domain=Greenland
grid_name_src=GRL-32KM
grid_name_tgt=GRL-4KM
nc_src=../ice_data/${domain}/${grid_name_src}/${grid_name_src}_REGIONS.nc 

cdo gencon,grid_${grid_name_tgt}.txt -setgrid,grid_${grid_name_src}.txt ${nc_src} scrip-con_${grid_name_src}_${grid_name_tgt}.nc

</code></pre>
<p>Now let's try to run a simulation at 16km, loading the restart file from 32km</p>
<pre><code class="language-bash">./runme -r -e initmip -n par/yelmo_initmip.nml -o output/restarts/sim2-16km -p ctrl.time_end=100 ctrl.time_equil=0 ctrl.clim_nm=&quot;clim_pd_grl&quot; yelmo.domain=&quot;Greenland&quot; yelmo.grid_name=&quot;GRL-16KM&quot; yelmo.restart=&quot;../sim0-32km/yelmo_restart.nc&quot;
</code></pre>
<p>The simulation is successful! (as of branch <code>alex-dev-2</code>, revision <code>1d9783fb</code>).</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
